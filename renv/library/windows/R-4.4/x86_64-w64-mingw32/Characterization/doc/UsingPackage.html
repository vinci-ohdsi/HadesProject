<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="generator" content="litedown 0.7">
<title>Using Characterization Package</title>
<style type="text/css">
body {
  font-family: sans-serif;
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 1.5;
  print-color-adjust: exact;
  -webkit-print-color-adjust: exact;
}
body, .abstract, code, .footnotes, footer, #refs, .caption { font-size: .9em; }
li li { font-size: .95em; }
ul:has(li > input[type="checkbox"]) { list-style: none; padding-left: 1em; }
*, :before, :after { box-sizing: border-box; }
a { color: steelblue; }
pre, img { max-width: 100%; }
pre { white-space: pre-wrap; word-break: break-word; }
pre code { display: block; padding: 1em; overflow-x: auto; }
code { font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace; }
:not(pre, th) > code, code[class], div > .caption { background: #f8f8f8; }
pre > code:is(:not([class]), .language-plain, .language-none, .plain), .box, .figure, .table { background: inherit; border: 1px solid #eee; }
pre > code {
  &.message { border-color: #9eeaf9; }
  &.warning { background: #fff3cd; border-color: #fff3cd; }
  &.error { background: #f8d7da; border-color: #f8d7da; }
}
.fenced-chunk { border-left: 1px solid #666; }
.code-fence {
  opacity: .4;
  border: 1px dashed #666;
  border-left: 2px solid;
  &:hover { opacity: inherit; }
}
.box, .figure, .table, table { margin: 1em auto; }
div > .caption { padding: 1px 1em; }
.figure { p:has(img, svg), pre:has(svg) { text-align: center; } }
.flex-col { display: flex; justify-content: space-between; }
table {
  &:only-child:not(.table > *) { margin: auto; }
  th, td { padding: 5px; font-variant-numeric: tabular-nums; }
  thead, tfoot, tr:nth-child(even) { background: whitesmoke; }
  thead th { border-bottom: 1px solid #ddd; }
  &:not(.datatable-table) {
    border-top: 1px solid #666;
    border-bottom: 1px solid #666;
  }
}
blockquote {
  color: #666;
  margin: 0;
  padding: 1px 1em;
  border-left: .5em solid #eee;
}
hr, .footnotes::before { border: 1px dashed #ddd; }
.frontmatter { text-align: center; }
#TOC {
  a { text-decoration: none; }
  ul { list-style: none; padding-left: 1em; }
  & > ul { padding: 0; }
  ul ul { border-left: 1px solid lightsteelblue; }
}
.body h2 { border-bottom: 1px solid #666; }
.body .appendix, .appendix ~ h2 { border-bottom-style: dashed; }
.main-number::after { content: "."; }
span[class^="ref-number-"] { font-weight: bold; }
.ref-number-fig::after, .ref-number-tab::after { content: ":"; }
.cross-ref-chp::before { content: "Chapter "; }
.cross-ref-sec::before { content: "Section "; }
.cross-ref-fig::before, .ref-number-fig::before { content: "Figure "; }
.cross-ref-tab::before, .ref-number-tab::before { content: "Table "; }
.cross-ref-eqn::before, .MathJax_ref:has(mjx-mtext > mjx-c + mjx-c)::before { content: "Equation "; }
.abstract, #refs {
  &::before { display: block; margin: 1em auto; font-weight: bold; }
}
.abstract::before { content: "Abstract"; text-align: center; }
#refs::before { content: "Bibliography"; font-size: 1.5em; }
.ref-paren-open::before { content: "("; }
.ref-paren-close::after { content: ")"; }
.ref-semicolon::after { content: "; "; }
.ref-and::after { content: " and "; }
.ref-et-al::after { content: " et al."; font-style: italic; }
.footnote-ref a {
  &::before { content: "["; }
  &::after { content: "]"; }
}
section.footnotes {
  margin-top: 2em;
  &::before { content: ""; display: block; max-width: 20em; }
}
.fade {
  background: repeating-linear-gradient(135deg, white, white 30px, #ddd 32px, #ddd 32px);
  opacity: 0.6;
}

@media print {
  body { max-width: 100%; }
  tr, img { break-inside: avoid; }
}
@media only screen and (min-width: 992px) {
  body:not(.pagesjs) pre:has(.line-numbers):not(:hover) { white-space: pre; }
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xiee/utils@1.14.14/css/prism-xcode.min.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" defer></script>
</head>
<body>
<div class="frontmatter">
<div class="title"><h1>Using Characterization Package</h1></div>
<div class="author"><h2>Jenna Reps</h2></div>
<div class="date"><h3>2025-09-09</h3></div>
</div>
<div class="body">
<div id="TOC">
<ul class="numbered">
<li><a href="#chp:introduction"><span class="section-number main-number">1</span> Introduction</a></li>
<li><a href="#chp:setup"><span class="section-number main-number">2</span> Setup</a></li>
<li><a href="#chp:examples"><span class="section-number main-number">3</span> Examples</a>
<ul>
<li><a href="#sec:aggreagate-covariates"><span class="section-number">3.1</span> Aggreagate Covariates</a></li>
<li><a href="#sec:dechallenge-rechallenge"><span class="section-number">3.2</span> Dechallenge Rechallenge</a></li>
<li><a href="#sec:time-to-event"><span class="section-number">3.3</span> Time to Event</a></li>
<li><a href="#sec:run-multiple"><span class="section-number">3.4</span> Run Multiple</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="chp:introduction"><span class="section-number main-number">1</span> Introduction</h1>
<p>This vignette describes how you can use the Characterization package for various descriptive studies using OMOP CDM data. The Characterization package currently contains three different types of analyses:</p>
<ul>
<li>Aggregate Covariates: this returns the mean feature value for a set of features specified by the user for i) the Target cohort population, ii) the Outcome cohort population, iii) the Target population patients who had the outcome during some user specified time-at-risk and iv) the Target population patients who did not have the outcome during some user specified time-at-risk.</li>
<li>DechallengeRechallenge: this is mainly aimed at investigating whether a drug and event are causally related by seeing whether the drug is stopped close in time to the event occurrence (dechallenge) and then whether the drug is restarted (a rechallenge occurs) and if so, whether the event starts again (a failed rechallenge). In this analysis, the Target cohorts are the drug users of interest and the Outcome cohorts are the medical events you wish to see whether the drug may cause.  The user must also specify how close in time a drug must be stopped after the outcome to be considered a dechallenge and how close in time an Outcome must occur after restarting the drug to be considered a failed rechallenge).</li>
<li>Time-to-event: this returns descriptive results showing the timing between the target cohort and outcome.  This can help identify whether the outcome often precedes the target cohort or whether it generally comes after.</li>
</ul>
<h1 id="chp:setup"><span class="section-number main-number">2</span> Setup</h1>
<p>First we need to install the <code>Characterization</code> package:</p>
<pre><code class="language-r">remotes::install_github(&quot;ohdsi/Characterization&quot;)
</code></pre>
<p>and then load it:</p>
<pre><code class="language-r">library(Characterization)
library(dplyr)
</code></pre>
<pre><code>## Warning: package 'dplyr' was built under R version 4.4.3
</code></pre>
<pre><code>## 
## Attaching package: 'dplyr'
</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag
</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union
</code></pre>
<p>In this vignette we will show working examples using a sample of the <code>Eunomia</code> R package GI Bleed simulated data. The function <code>exampleOmopConnectionDetails</code> creates a connection details object for a SQLITE database containing an example observational medical outcomes partnership (OMOP) common data model (CDM) data in a temporary location.</p>
<pre><code class="language-r">connectionDetails &lt;- Characterization::exampleOmopConnectionDetails()
</code></pre>
<h1 id="chp:examples"><span class="section-number main-number">3</span> Examples</h1>
<h2 id="sec:aggreagate-covariates"><span class="section-number">3.1</span> Aggreagate Covariates</h2>
<p>To run an ‘Aggregate Covariate’ analysis you need to create a setting object using <code>createAggregateCovariateSettings</code>.  This requires specifying:</p>
<ul>
<li>one or more targetIds (these must be pre-generated in a cohort table)</li>
<li>one or more outcomeIds (these must be pre-generated in a cohort table)</li>
<li>the covariate settings using <code>FeatureExtraction::createCovariateSettings</code> or by creating your own custom feature extraction code.</li>
<li>the time-at-risk settings</li>
</ul>
<ul>
<li>riskWindowStart</li>
<li>startAnchor</li>
<li>riskWindowEnd</li>
<li>endAnchor</li>
</ul>
<p>Using the Eunomia data were we previous generated four cohorts, we can use cohort ids 1,2 and 4 as the targetIds and cohort id 3 as the outcomeIds:</p>
<pre><code class="language-r">exampleTargetIds &lt;- c(1, 2, 4)
exampleOutcomeIds &lt;- 3
</code></pre>
<p>If we want to get information on the sex, age at index and Charlson Comorbidity index we can create the settings using <code>FeatureExtraction::createCovariateSettings</code>:</p>
<pre><code class="language-r">exampleCovariateSettings &lt;- FeatureExtraction::createCovariateSettings(
  useDemographicsGender = T,
  useDemographicsAge = T,
  useCharlsonIndex = T
)
</code></pre>
<p>There is an additional covariate setting require that is calculated for the cases (patients in the target cohort with have the outcome during the time-at-risk).  This is called caseCovariateSettings and should be created using the createDuringCovariateSettings function.  The user can pick conditions, drugs, measurements, procedures and observations.  In this example, we just include condition eras groups by vocabulary heirarchy.  We also need to specify two related variables <code>casePreTargetDuration</code> which is the number of days before target index to extract features for the cases (answers what happens shortly before the target index) and <code>casePostOutcomeDuration</code> which is the number of days after the outcome date to extract features for the cases (answers what happens after the outcome).  The case covariates are also extracted between target index and outcome (answers the question what happens during target exposure).</p>
<pre><code class="language-r">caseCovariateSettings &lt;- Characterization::createDuringCovariateSettings(
  useConditionGroupEraDuring = T
)
</code></pre>
<p>If we want to create the aggregate features for all our target cohorts, our outcome cohort and each target cohort restricted to those with a record of the outcome 1 day after target cohort start date until 365 days after target cohort end date with a outcome washout of 9999 (meaning we only include outcomes that are the first occurrence in the past 9999 days) and only include targets or outcomes where the patient was observed for 365 days or more prior, we can run:</p>
<pre><code class="language-r">exampleAggregateCovariateSettings &lt;- createAggregateCovariateSettings(
  targetIds = exampleTargetIds,
  outcomeIds = exampleOutcomeIds,
  riskWindowStart = 1, startAnchor = &quot;cohort start&quot;,
  riskWindowEnd = 365, endAnchor = &quot;cohort start&quot;,
  outcomeWashoutDays = 9999,
  minPriorObservation = 365,
  covariateSettings = exampleCovariateSettings,
  caseCovariateSettings = caseCovariateSettings,
  casePreTargetDuration = 90,
  casePostOutcomeDuration = 90
)
</code></pre>
<p>Next we need to use the <code>exampleAggregateCovariateSettings</code> as the settings to <code>computeAggregateCovariateAnalyses</code>, we need to use the Eunomia connectionDetails and in Eunomia the OMOP CDM data and cohort table are in the ‘main’ schema.  The cohort table name is ‘cohort’.  The following code will apply the aggregated covariates analysis using the previously specified settings on the simulated Eunomia data, but we can specify the <code>minCharacterizationMean</code> to exclude covarites with mean values below 0.01, and we must specify the <code>outputFolder</code> where the csv results will be written to.</p>
<pre><code class="language-r">runCharacterizationAnalyses(
  connectionDetails = connectionDetails,
  cdmDatabaseSchema = &quot;main&quot;,
  targetDatabaseSchema = &quot;main&quot;,
  targetTable = &quot;cohort&quot;,
  outcomeDatabaseSchema = &quot;main&quot;,
  outcomeTable = &quot;cohort&quot;,
  characterizationSettings = createCharacterizationSettings(
    aggregateCovariateSettings = exampleAggregateCovariateSettings
  ),
  databaseId = &quot;Eunomia&quot;,
  runId = 1,
  minCharacterizationMean = 0.01,
  outputDirectory = file.path(tempdir(), &quot;example_char&quot;, &quot;results&quot;), 
  executionPath = file.path(tempdir(), &quot;example_char&quot;, &quot;execution&quot;),
  minCellCount = 10,
  incremental = F,
  threads = 1
)
</code></pre>
<p>You can then see the results in the location <code>file.path(tempdir(), 'example_char', 'results')</code> where you will find csv files.</p>
<h2 id="sec:dechallenge-rechallenge"><span class="section-number">3.2</span> Dechallenge Rechallenge</h2>
<p>To run a ‘Dechallenge Rechallenge’ analysis you need to create a setting object using <code>createDechallengeRechallengeSettings</code>.  This requires specifying:</p>
<ul>
<li>one or more targetIds (these must be pre-generated in a cohort table)</li>
<li>one or more outcomeIds (these must be pre-generated in a cohort table)</li>
<li>dechallengeStopInterval</li>
<li>dechallengeEvaluationWindow</li>
</ul>
<p>Using the Eunomia data were we previous generated four cohorts, we can use cohort ids 1,2 and 4 as the targetIds and cohort id 3 as the outcomeIds:</p>
<pre><code class="language-r">exampleTargetIds &lt;- c(1, 2, 4)
exampleOutcomeIds &lt;- 3
</code></pre>
<p>If we want to create the dechallenge rechallenge for all our target cohorts and our outcome cohort with a 30 day dechallengeStopInterval and 31 day dechallengeEvaluationWindow:</p>
<pre><code class="language-r">exampleDechallengeRechallengeSettings &lt;- createDechallengeRechallengeSettings(
  targetIds = exampleTargetIds,
  outcomeIds = exampleOutcomeIds,
  dechallengeStopInterval = 30,
  dechallengeEvaluationWindow = 31
)
</code></pre>
<p>We can then run  the analysis on the Eunomia data using <code>computeDechallengeRechallengeAnalyses</code> and the settings previously specified, with <code>minCellCount</code> removing values less than the specified value:</p>
<pre><code class="language-r">dc &lt;- computeDechallengeRechallengeAnalyses(
  connectionDetails = connectionDetails,
  targetDatabaseSchema = &quot;main&quot;,
  targetTable = &quot;cohort&quot;,
  settings = exampleDechallengeRechallengeSettings,
  databaseId = &quot;Eunomia&quot;,
  outcomeFolder = file.path(tempdir(), &quot;example_char&quot;, &quot;results&quot;),
  minCellCount = 5
)
</code></pre>
<p>Next it is possible to compute the failed rechallenge cases</p>
<pre><code class="language-r">failed &lt;- computeRechallengeFailCaseSeriesAnalyses(
  connectionDetails = connectionDetails,
  targetDatabaseSchema = &quot;main&quot;,
  targetTable = &quot;cohort&quot;,
  settings = exampleDechallengeRechallengeSettings,
  outcomeDatabaseSchema = &quot;main&quot;,
  outcomeTable = &quot;cohort&quot;,
  databaseId = &quot;Eunomia&quot;,
  outcomeFolder = file.path(tempdir(), &quot;example_char&quot;, &quot;results&quot;),
  minCellCount = 5
)
</code></pre>
<h2 id="sec:time-to-event"><span class="section-number">3.3</span> Time to Event</h2>
<p>To run a ‘Time-to-event’ analysis you need to create a setting object using <code>createTimeToEventSettings</code>.  This requires specifying:</p>
<ul>
<li>one or more targetIds (these must be pre-generated in a cohort table)</li>
<li>one or more outcomeIds (these must be pre-generated in a cohort table)</li>
</ul>
<pre><code class="language-r">exampleTimeToEventSettings &lt;- createTimeToEventSettings(
  targetIds = exampleTargetIds,
  outcomeIds = exampleOutcomeIds
)
</code></pre>
<p>We can then run  the analysis on the Eunomia data using <code>computeTimeToEventAnalyses</code> and the settings previously specified:</p>
<pre><code class="language-r">tte &lt;- computeTimeToEventAnalyses(
  connectionDetails = connectionDetails,
  cdmDatabaseSchema = &quot;main&quot;,
  targetDatabaseSchema = &quot;main&quot;,
  targetTable = &quot;cohort&quot;,
  settings = exampleTimeToEventSettings,
  databaseId = &quot;Eunomia&quot;,
  outcomefolder = file.path(tempdir(), &quot;example_char&quot;, &quot;results&quot;),
  minCellCount = 5
)
</code></pre>
<h2 id="sec:run-multiple"><span class="section-number">3.4</span> Run Multiple</h2>
<p>If you want to run multiple analyses (of the three previously shown) you can use <code>createCharacterizationSettings</code>.  You need to input a list of each of the settings (or NULL if you do not want to run one type of analysis).  To run all the analyses previously shown in one function:</p>
<pre><code class="language-r">characterizationSettings &lt;- createCharacterizationSettings(
  timeToEventSettings = list(
    exampleTimeToEventSettings
  ),
  dechallengeRechallengeSettings = list(
    exampleDechallengeRechallengeSettings
  ),
  aggregateCovariateSettings = exampleAggregateCovariateSettings
)

# save the settings using
saveCharacterizationSettings(
  settings = characterizationSettings,
  saveDirectory = file.path(tempdir(), &quot;saveSettings&quot;)
)

# the settings can be loaded
characterizationSettings &lt;- loadCharacterizationSettings(
  saveDirectory = file.path(tempdir(), &quot;saveSettings&quot;)
)

runCharacterizationAnalyses(
  connectionDetails = connectionDetails,
  cdmDatabaseSchema = &quot;main&quot;,
  targetDatabaseSchema = &quot;main&quot;,
  targetTable = &quot;cohort&quot;,
  outcomeDatabaseSchema = &quot;main&quot;,
  outcomeTable = &quot;cohort&quot;,
  characterizationSettings = characterizationSettings,
  outputDirectory = file.path(tempdir(), &quot;example&quot;, &quot;results&quot;),
  executionPath = file.path(tempdir(), &quot;example&quot;, &quot;execution&quot;),
  csvFilePrefix = &quot;c_&quot;,
  databaseId = &quot;1&quot;,
  incremental = F,
  minCharacterizationMean = 0.01,
  minCellCount = 5
)
</code></pre>
<p>This will create csv files with the results in the saveDirectory.  You can run the following code to view the results in a shiny app:</p>
<pre><code class="language-r">viewCharacterization(
  resultFolder = file.path(tempdir(), &quot;example&quot;, &quot;results&quot;),
  cohortDefinitionSet = NULL
)
</code></pre>
</div>
</body>
</html>
